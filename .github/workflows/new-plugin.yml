name: New UE Plugin Project
'on':
  workflow_dispatch:
    inputs:
      org:
        description: GitHub org or user
        required: true
        default: lifelike-and-believable
      template_repo:
        description: Template repo (org/name)
        required: true
        default: lifelike-and-believable/ue-plugin-template
      visibility:
        description: private|public|internal
        required: true
        default: private
      repo_name:
        description: Optional explicit repo name
        required: false
      requirements:
        description: Freeform requirements prompt
        required: true
jobs:
  factory:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          if ! command -v gh >/dev/null; then
            type -p curl >/dev/null && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh -y
          fi
      - name: Authenticate gh
        env:
          GH_TOKEN: ${{ secrets.FACTORY_ADMIN_TOKEN }}
        run: gh auth status
      - name: Parse requirements
        id: parse
        env:
          REQ: ${{ inputs.requirements }}
        run: |
          python3 scripts/parser.py > spec.json
          echo "plugin_name=$(jq -r .plugin_name spec.json)" >> $GITHUB_OUTPUT
          echo "ue_version=$(jq -r .ue_version spec.json)" >> $GITHUB_OUTPUT
          
      - name: Create repository from template
        env:
          GH_TOKEN: ${{ secrets.FACTORY_ADMIN_TOKEN }}
        run: |
          PLUGIN="${{ steps.parse.outputs.plugin_name }}"
          REPO_NAME="${{ inputs.repo_name }}"
          
          if [ -z "$REPO_NAME" ]; then
            SLUG=$(echo "$PLUGIN" | tr "[:upper:]" "[:lower:]")
            REPO_NAME="ue-$SLUG"
          fi
          
          echo "Creating repository ${{ inputs.org }}/$REPO_NAME from template ${{ inputs.template_repo }}"
          gh repo create "${{ inputs.org }}/$REPO_NAME" \
            --${{ inputs.visibility }} \
            --template "${{ inputs.template_repo }}"
          
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          
      - name: Create issue and assign to Copilot Agent
        env:
          GH_TOKEN: ${{ secrets.FACTORY_ADMIN_TOKEN }}
        run: |
          PLUGIN="${{ steps.parse.outputs.plugin_name }}"
          UE_VERSION="${{ steps.parse.outputs.ue_version }}"
          REQUIREMENTS="${{ inputs.requirements }}"
          
          # Construct the problem statement for Copilot Agent
          cat > issue_body.md << 'EOF'
          # Implement Unreal Engine Plugin: $PLUGIN
          
          ## Requirements
          $REQUIREMENTS
          
          ## Technical Context
          - Unreal Engine Version: $UE_VERSION
          - Target Platforms: Win64
          - Template Structure: This repo was created from ue-plugin-template
          
          ## Tasks
          1. Rename all instances of `SamplePlugin` to `$PLUGIN` including:
             - Directory names in `Plugins/`
             - Source module folders
             - .uplugin file
             - All code references
             - Build.cs files
          
          2. Update `ProjectSandbox/ProjectSandbox.uproject` to set correct engine version
          
          3. Implement the plugin functionality based on the requirements above
          
          4. Ensure all tests in `Source/$PLUGINTests/` are updated and pass
          
          5. Update README.md with plugin-specific documentation
          
          ## Build & Test
          The repo has a `pr-ci.yml` workflow that will automatically:
          - Build the plugin using UAT
          - Run automation tests
          - Upload artifacts
          
          Please ensure your implementation will build and pass tests on Windows with UE $UE_VERSION installed at `C:\UE\UE_5.6`.
          EOF
          
          # Replace variables in the issue body
          sed -i "s/\$PLUGIN/$PLUGIN/g" issue_body.md
          sed -i "s/\$UE_VERSION/$UE_VERSION/g" issue_body.md
          sed -i "s/\$REQUIREMENTS/$REQUIREMENTS/g" issue_body.md
          
          # Create the issue and assign to @copilot
          echo "Creating issue in ${{ inputs.org }}/$REPO_NAME"
          gh issue create \
            --repo "${{ inputs.org }}/$REPO_NAME" \
            --title "Initialize $PLUGIN plugin" \
            --body-file issue_body.md \
            --assignee @copilot
